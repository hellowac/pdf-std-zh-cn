# 11.3 基本合成计算

**11.3 Basic Compositing Computations**

## 11.3.1 概述

**11.3.1 General**

=== "中文"

    This sub-clause describes the basic computations for compositing a single object with its backdrop. These computations are extended in [11.4], "Transparency Groups," to cover groups consisting of multiple objects.

=== "英文"

    This sub-clause describes the basic computations for compositing a single object with its backdrop. These computations are extended in [11.4], "Transparency Groups," to cover groups consisting of multiple objects.


## 11.3.2 合成计算的基本符号

**11.3.2 Basic Notation for Compositing Computations**

=== "中文"

    In general, variable names in this clause consisting of a lowercase letter denote a scalar quantity, such as an opacity. Uppercase letters denote a value with multiple scalar components, such as a colour. In the descriptions of the basic colour compositing computations, colour values are generally denoted by the letter C, with a mnemonic subscript indicating which of several colour values is being referred to; for instance, C<sub>s</sub> stands for “source colour.” Shape and opacity values are denoted respectively by the letters f (for “form factor”) and q (for “opaqueness”)—again with a mnemonic subscript, such as q<sub>s</sub> for “source opacity.” The symbol α (alpha) stands for a product of shape and opacity values.
    
    In certain computations, one or more variables may have undefined values; for instance, when opacity is equal to zero, the corresponding colour is undefined. A quantity can also be undefined if it results from division by zero. In any formula that uses such an undefined quantity, the quantity has no effect on the ultimate result because it is subsequently multiplied by zero or otherwise cancelled out. It is significant that while any arbitrary value may be chosen for such an undefined quantity, the computation shall not malfunction because of exceptions caused by overflow or division by zero. The further convention that 0 ÷ 0 = 0 should also be adopted.

=== "英文"

    In general, variable names in this clause consisting of a lowercase letter denote a scalar quantity, such as an opacity. Uppercase letters denote a value with multiple scalar components, such as a colour. In the descriptions of the basic colour compositing computations, colour values are generally denoted by the letter C, with a mnemonic subscript indicating which of several colour values is being referred to; for instance, C<sub>s</sub> stands for “source colour.” Shape and opacity values are denoted respectively by the letters f (for “form factor”) and q (for “opaqueness”)—again with a mnemonic subscript, such as q<sub>s</sub> for “source opacity.” The symbol α (alpha) stands for a product of shape and opacity values.
    
    In certain computations, one or more variables may have undefined values; for instance, when opacity is equal to zero, the corresponding colour is undefined. A quantity can also be undefined if it results from division by zero. In any formula that uses such an undefined quantity, the quantity has no effect on the ultimate result because it is subsequently multiplied by zero or otherwise cancelled out. It is significant that while any arbitrary value may be chosen for such an undefined quantity, the computation shall not malfunction because of exceptions caused by overflow or division by zero. The further convention that 0 ÷ 0 = 0 should also be adopted.


## 11.3.3 基本合成公式

**11.3.3 Basic Compositing Formula**

=== "中文"

    The primary change in the imaging model to accommodate transparency is in how colours are painted. In the transparent model, the result of painting (the *result colour*) is a function of both the colour being painted (the *source colour*) and the colour it is painted over (the *backdrop colour*). Both of these colours may vary as a function of position on the page; however, this sub-clause focuses on some fixed point on the page and assumes a fixed backdrop and source colour.
    
    This computation uses two other parameters: alpha, which controls the relative contributions of the backdrop and source colours, and the blend function, which specifies how they shall be combined in the painting operation. The resulting basic colour compositing formula (or just *basic compositing formula* for short) shall determine the result colour produced by the painting operation:
    
    $C_r = \left ( 1- \frac{\alpha_s}{\alpha_r} \right ) \times C_b +  \frac{\alpha_s}{\alpha_r} \times [(1 - \alpha _b) \times C_s + \alpha _b \times B(C_b, C_s)]$
    
    where the variables have the meanings shown in Table 135.
                    
    <table id="table135" markdown="span">
        <caption>**Table 135 – Variables used in the basic compositing formula**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$C_b$</td>
                <td>Backdrop colour</td>
            </tr>
            <tr>
                <td>$C_s$</td>
                <td>Source colour</td>
            </tr>
            <tr>
                <td>$C_r$</td>
                <td>Result colour</td>
            </tr>
            <tr>
                <td>$\alpha_b$</td>
                <td>Backdrop alpha</td>
            </tr>
            <tr>
                <td>$\alpha_s$</td>
                <td>Source alpha</td>
            </tr>
            <tr>
                <td>$\alpha_r$</td>
                <td>Result alpha</td>
            </tr>
            <tr>
                <td>$B(C_b , C_s)$</td>
                <td>Blend function</td>
            </tr>
        </tbody>
    </table>
    
    This formula represents a simplified form of the compositing formula in which the shape and opacity values are combined and represented as a single alpha value; the more general form is presented later. This function is based on the **over** operation **defined in the article “Compositing Digital Images,” by Porter and Duff (see the Bibliography)**, extended to include a blend mode in the region of overlapping coverage. The following sub- clauses elaborate on the meaning and implications of this formula.

=== "英文"

    The primary change in the imaging model to accommodate transparency is in how colours are painted. In the transparent model, the result of painting (the *result colour*) is a function of both the colour being painted (the *source colour*) and the colour it is painted over (the *backdrop colour*). Both of these colours may vary as a function of position on the page; however, this sub-clause focuses on some fixed point on the page and assumes a fixed backdrop and source colour.
    
    This computation uses two other parameters: alpha, which controls the relative contributions of the backdrop and source colours, and the blend function, which specifies how they shall be combined in the painting operation. The resulting basic colour compositing formula (or just *basic compositing formula* for short) shall determine the result colour produced by the painting operation:
    
    $C_r = \left ( 1- \frac{\alpha_s}{\alpha_r} \right ) \times C_b +  \frac{\alpha_s}{\alpha_r} \times [(1 - \alpha _b) \times C_s + \alpha _b \times B(C_b, C_s)]$
    
    where the variables have the meanings shown in Table 135.
                    
    <table id="table135" markdown="span">
        <caption>**Table 135 – Variables used in the basic compositing formula**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$C_b$</td>
                <td>Backdrop colour</td>
            </tr>
            <tr>
                <td>$C_s$</td>
                <td>Source colour</td>
            </tr>
            <tr>
                <td>$C_r$</td>
                <td>Result colour</td>
            </tr>
            <tr>
                <td>$\alpha_b$</td>
                <td>Backdrop alpha</td>
            </tr>
            <tr>
                <td>$\alpha_s$</td>
                <td>Source alpha</td>
            </tr>
            <tr>
                <td>$\alpha_r$</td>
                <td>Result alpha</td>
            </tr>
            <tr>
                <td>$B(C_b , C_s)$</td>
                <td>Blend function</td>
            </tr>
        </tbody>
    </table>
    
    This formula represents a simplified form of the compositing formula in which the shape and opacity values are combined and represented as a single alpha value; the more general form is presented later. This function is based on the **over** operation **defined in the article “Compositing Digital Images,” by Porter and Duff (see the Bibliography)**, extended to include a blend mode in the region of overlapping coverage. The following sub- clauses elaborate on the meaning and implications of this formula.

## 11.3.4 混合色彩空间

**11.3.4 Blending Colour Space**

=== "中文"

    The compositing formula shown in [11.3.3], "Basic Compositing Formula," represents a vector function: the colours it operates on are represented in the form of n-element vectors, where n denotes the number of components required by the colour space in used in the compositing process. The *i*th component of the result colour $C_r$ shall be obtained by applying the compositing formula to the ith components of the constituent colours $C_b$ , $C_s$ , and $B(C_b, C_s)$. The result of the computation thus depends on the colour space in which the colours are represented. For this reason, the colour space used for compositing, called the blending colour space, is explicitly made part of the transparent imaging model. When necessary, backdrop and source colours shall be converted to the blending colour space before the compositing computation.
    
    Of the PDF colour spaces described in Section 8.6, the following shall be supported as blending colour spaces:
    
    - **DeviceGray**
    - **DeviceRGB**
    - **DeviceCMYK**
    - **CalGray**
    - **CalRGB**
    - **ICCBased** colour spaces equivalent to the preceding (including calibrated CMYK)
    
    The **Lab** space and **ICCBased** spaces that represent lightness and chromaticity separately (such as *L\*a\*b\**, *L\*u\*v\**, and *HSV*) shall not be used as blending colour spaces because the compositing computations in such spaces do not give meaningful results when applied separately to each component. In addition, an **ICCBased** space used as a blending colour space shall be bidirectional; that is, the ICC profile shall contain both AToB and *BToA* transformations.
    
    The blending colour space shall be consulted only for process colours. Although blending may also be done on individual spot colours specified in a **Separation** or **DeviceN** colour space, such colours shall not be converted to a blending colour space (except in the case where they first revert to their alternate colour space, as described under Section [8.6.6.4] and “DeviceN Colour Spaces”). Instead, the specified colour components shall be blended individually with the corresponding components of the backdrop.
    
    The blend functions for the various blend modes are defined such that the range for each colour component shall be 0.0 to 1.0 and that the colour space shall be additive. When performing blending operations in subtractive colour spaces (**DeviceCMYK**, **Separation**, and **DeviceN**), the colour component values shall be complemented (subtracted from 1.0) before the blend function is applied and the results of the function shall then be complemented back before being used.
    
    !!! note "NOTE"
    
        This adjustment makes the effects of the various blend modes numerically consistent across all colour spaces. However, the actual visual effect produced by a given blend mode still depends on the colour space. Blending in a device colour space produces device-dependent results, whereas in a CIE-based space it produces results that are consistent across all devices. See [11.7], "Colour Space and Rendering Issues," for additional details concerning colour spaces.

=== "英文"

    The compositing formula shown in [11.3.3], "Basic Compositing Formula," represents a vector function: the colours it operates on are represented in the form of n-element vectors, where n denotes the number of components required by the colour space in used in the compositing process. The *i*th component of the result colour $C_r$ shall be obtained by applying the compositing formula to the ith components of the constituent colours $C_b$ , $C_s$ , and $B(C_b, C_s)$. The result of the computation thus depends on the colour space in which the colours are represented. For this reason, the colour space used for compositing, called the blending colour space, is explicitly made part of the transparent imaging model. When necessary, backdrop and source colours shall be converted to the blending colour space before the compositing computation.
    
    Of the PDF colour spaces described in Section 8.6, the following shall be supported as blending colour spaces:
    
    - **DeviceGray**
    - **DeviceRGB**
    - **DeviceCMYK**
    - **CalGray**
    - **CalRGB**
    - **ICCBased** colour spaces equivalent to the preceding (including calibrated CMYK)
    
    The **Lab** space and **ICCBased** spaces that represent lightness and chromaticity separately (such as *L\*a\*b\**, *L\*u\*v\**, and *HSV*) shall not be used as blending colour spaces because the compositing computations in such spaces do not give meaningful results when applied separately to each component. In addition, an **ICCBased** space used as a blending colour space shall be bidirectional; that is, the ICC profile shall contain both AToB and *BToA* transformations.
    
    The blending colour space shall be consulted only for process colours. Although blending may also be done on individual spot colours specified in a **Separation** or **DeviceN** colour space, such colours shall not be converted to a blending colour space (except in the case where they first revert to their alternate colour space, as described under Section [8.6.6.4] and “DeviceN Colour Spaces”). Instead, the specified colour components shall be blended individually with the corresponding components of the backdrop.
    
    The blend functions for the various blend modes are defined such that the range for each colour component shall be 0.0 to 1.0 and that the colour space shall be additive. When performing blending operations in subtractive colour spaces (**DeviceCMYK**, **Separation**, and **DeviceN**), the colour component values shall be complemented (subtracted from 1.0) before the blend function is applied and the results of the function shall then be complemented back before being used.
    
    !!! note "NOTE"
    
        This adjustment makes the effects of the various blend modes numerically consistent across all colour spaces. However, the actual visual effect produced by a given blend mode still depends on the colour space. Blending in a device colour space produces device-dependent results, whereas in a CIE-based space it produces results that are consistent across all devices. See [11.7], "Colour Space and Rendering Issues," for additional details concerning colour spaces.

## 11.3.5 混合模式

**11.3.5 Blend Mode**

=== "中文"

    In principle, any function of the backdrop and source colours that yields another colour, $C_r$, for the result may be used as a blend function $B(C_b , C_s)$, in the compositing formula to customize the blending operation. PDF defines a standard set of named blend functions, or *blend modes*, listed in Tables 136 and 137. Figures L.18 and L.19 in [Annex L] illustrate the resulting visual effects for *RGB* and *CMYK* colours, respectively.
    
    A blend mode is termed *separable* if each component of the result colour is completely determined by the corresponding components of the constituent backdrop and source colours—that is, if the blend mode function B is applied separately to each set of corresponding components:
    
    $c_r = B(c_b, c_s)$
    
    where the lowercase variables $c_r$, $c_b$ , and $c_s$ denote corresponding components of the colours $C_r$ , $C_b$ , and $C_s$ , expressed in additive form. A separable blend mode may be used with any colour space, since it applies independently to any number of components. Only separable blend modes shall be used for blending spot colours.
    
    !!! note "NOTE 1"
    
        Theoretically, a blend mode could have a different function for each colour component and still be separable; however, none of the standard PDF blend modes have this property.
    
    Table 136 lists the standard separable blend modes available in PDF and the algorithms/formulas that shall be used in the calculation of blended colours.
                        
    <table id="table136" markdown="span">
        <caption>**Table 136 – Standard separable blend modes**</caption>
        <thead>
            <tr>
                <th>**Name**</th>
                <th>**Result**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>**Normal**</td>
                <td>$B ( c_b , c_s ) = c_s$<br/><br/>
                    NOTE &emsp; Selects the source colour, ignoring the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Compatible**</td>
                <td>Same as Normal. This mode exists only for compatibility and should not be used.
                </td>
            </tr>
            <tr>
                <td>**Multiply**</td>
                <td>$B ( c_b , c_s ) = c_b \times c_s$<br/><br/>
                    NOTE 1 &emsp; Multiplies the backdrop and source colour values.<br/>
                    NOTE 2 &emsp; The result colour is always at least as dark as either of the two constituent colours. Multiplying any colour with black produces black; multiplying with white leaves the original colour unchanged. Painting successive overlapping objects with a colour other than black or white produces progressively darker colours.
                </td>
            </tr>
            <tr>
                <td>**Screen**</td>
                <td>$\begin{align} B(c_b,c_s) &= 1-[(1-c_b)\times (1-c_s)]\\   &= c_b + c_s -(c_b \times c_s) \end{align}$<br/><br/>
                    NOTE 3 &emsp; Multiplies the complements of the backdrop and source colour values, then complements the result.<br/>
                    NOTE 4 &emsp; The result colour is always at least as light as either of the two constituent colours. Screening any colour with white produces white; screening with black leaves the original colour unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.
                </td>
            </tr>
            <tr>
                <td>**Overlay**</td>
                <td>$B(c_b, c_s) = \text{HardLight}(c_s, c_b)$<br/><br/>
                    NOTE 5 &emsp; Multiplies or screens the colours, depending on the backdrop colour value. Source colours overlay the backdrop while preserving its highlights and shadows. The backdrop colour is not replaced but is mixed with the source colour to reflect the lightness or darkness of the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Darken**</td>
                <td>$B ( c_b , c_s ) = \text{min}(c_b, c_s)$<br/><br/>
                    NOTE 6 &emsp; Selects the darker of the backdrop and source colours. <br/>
                    NOTE 7 &emsp; The backdrop is replaced with the source where the source is darker; otherwise, it is left unchanged. 
                </td>
            </tr>
            <tr>
                <td>**Lighten**</td>
                <td>$B ( c_b , c_s ) = \text{max}(c_b, c_s)$<br/><br/>
                    NOTE 8 &emsp; Selects the lighter of the backdrop and source colours.<br/>
                    NOTE 9 &emsp; The backdrop is replaced with the source where the source is lighter; otherwise, it is left unchanged.<br/>
                </td>
            </tr>
            <tr>
                <td>**ColorDodge**</td>
                <td>$B(c_b, c_s) = \begin{cases}  \text{min}(1, c_b/(1-c_s))  & \text{if} \space c_s \lt 1 \\  1 & \text{if}  \space c_s = \end{cases}$<br/><br/>
                    NOTE 10 &emsp; Brightens the backdrop colour to reflect the source colour. Painting with black produces no changes.
                </td>
            </tr>
            <tr>
                <td>**ColorBurn**</td>
                <td>$B(c_b, c_s) = \begin{cases}  1 - \text{min}(1, (1-c_b)/c_s)  & \text{if} \space c_s \gt 0 \\  0 & \text{if}  \space c_s = \end{cases}$<br/><br/>
                    NOTE 11 &emsp; Darkens the backdrop colour to reflect the source colour. Painting with white produces no change.
                </td>
            </tr>
            <tr>
                <td>**HardLight**</td>
                <td>$B(c_b, c_s) = \begin{cases}  \text{Multiply}(c_b, 2 \times c_s) & \text{if} \space c_s \le 0.5 \\  \text{Screen}(c_b, 2\times c_s - 1) & \text{if}  \space c_s \gt 0.5 \end{cases}$<br/><br/>
                    NOTE 12 &emsp; Multiplies or screens the colours, depending on the source colour value. The effect is similar to shining a harsh spotlight on the backdrop.
                </td>
            </tr>
            <tr>
                <td>**SoftLight**</td>
                <td>$B(c_b, c_s) = \begin{cases}  c_b - (1-2\times c_s) \times c_b \times (1-c_b)  & \text{if} \space c_s \le 0.5 \\  c_b + (2 \times c_s - 1) \times (D(c_b) - c_b) & \text{if}  \space c_s \gt 0.5 \end{cases}$<br/>
                    **where**<br/>
                    $D(x) = \begin{cases}  ((16 \times x - 12) \times x + 4) \times x  & \text{if} \space x \le 0.25 \\  \sqrt{x}  & \text{if}  \space x \gt 0.25 \end{cases}$<br/><br/>
                    NOTE 13&emsp; Darkens or lightens the colours, depending on the source colour value. The effect is similar to shining a diffused spotlight on the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Difference**</td>
                <td>$B(c_b,c_s) = |c_b - c_s|$<br/><br/>
                    NOTE 14 &emsp; Subtracts the darker of the two constituent colours from the lighter colour: <br/>
                    NOTE 15 &emsp; Painting with white inverts the backdrop colour; painting with black produces no change.
                </td>
            </tr>
            <tr>
                <td>**Exclusion**</td>
                <td>$B ( c_b , c_s ) = c_b + c_s - 2 \times c_b \times c_s$<br/><br/>
                    NOTE 16 &emsp; Produces an effect similar to that of the **Difference** mode but lower in contrast. Painting with white inverts the backdrop colour; painting with black produces no change.
                </td>
            </tr>
        </tbody>
    </table>
    
    Table 137 lists the standard nonseparable blend modes. Since the nonseparable blend modes consider all colour components in combination, their computation depends on the blending colour space in which the components are interpreted. They may be applied to all multiple-component colour spaces that are allowed as blending colour spaces (see [“Blending Colour Space](../c11/s3.md#1134-混合色彩空间)”).
    
    !!! note "NOTE 2"
        
        All of these blend modes conceptually entail the following steps:
        
        a) Convert the backdrop and source colours from the blending colour space to an intermediate HSL (hue-saturation-luminosity) representation.
        
        b) Create a new colour from some combination of hue, saturation, and luminosity components selected from the backdrop and source colours.
        
        c) Convert the result back to the original (blending) colour space.
        
        However, the following formulas given do not actually perform these conversions. Instead, they start with whichever colour (backdrop or source) is providing the hue for the result; then they adjust this colour to have the proper saturation and luminosity.
    
    The nonseparable blend mode formulas make use of several auxiliary functions. These functions operate on colours that are assumed to have red, green, and blue components. Blending of *CMYK* colour spaces requires special treatment, as described in this sub-clause.
    
    These functions shall have the following definitions:
    
    $\text{Lum}(C) = 0.3 \times C_{red} + 0.59 \times C_{green} + 0.11 \times C_{blue}$
    
    $\begin{align} 
      \text{SetLum}&(C, 1) \\
      & \text{let} \space d = 1 - \text{Lum}(C) \\
      & C_{\text{red} } = C_{\text{red} } + d \\
      & C_{\text{green} } = C_{\text{green} } + d \\
      & C_{\text{blue} } = C_{\text{blue} } + d \\
      & \text{returnClipColor}(C)  
    \end{align}$
    
    $\begin{align} 
      \text{ClipColor}&(C) \\
      & \text{let} \space l = \text{Lum}(C) \\
      & \text{let} \space n = \text{min}(C_{\text{red} }, C_{\text{green} }, C_{\text{blue} }) \\
      & \text{let} \space x = \text{max}(C_{\text{red} }, C_{\text{green} }, C_{\text{blue} }) \\
      & if \space n \lt 0.0 \\
      & \qquad C_{\text{red} } = l + (((C_{\text{red} } -l) \times l)/(l-n))\\
      & \qquad C_{\text{green} } = l + (((C_{\text{green} } -l) \times l)/(l-n))\\
      & \qquad C_{\text{blue} } = l + (((C_{\text{blue} } -l) \times l)/(l-n))\\
      & if \space n \gt 1.0 \\
      & \qquad C_{\text{red} } = l + (((C_{\text{red} } -l) \times (1 – l))/(x – l))\\
      & \qquad C_{\text{green} } = l + (((C_{\text{green} } -l) \times (1 – l))/(x – l))\\
      & \qquad C_{\text{blue} } = l + (((C_{\text{blue} } -l) \times (1 – l))/(x – l))\\
      & \text{return} \space C
    \end{align}$
    
    $\text{Sat}(C) = \text{max}(C_{\text{red}}, C_{\text{green}}, C_{\text{blue}}) - \text{min}(C_{\text{red}}, C_{\text{green}}, C_{\text{blue}})$
    
    The subscripts *min*, *mid*, and *max* (in the next function) refer to the colour components having the minimum, middle, and maximum values upon entry to the function.
    
    $\begin{align} 
      \text{SetSat}&(C, s) \\
      & \text{if} \space C_{\text{max}} \gt C_{\text{min}} \\
      & \qquad C_{\text{min}} = (((C_{\text{mid}} - C_{\text{min}}) \times s)/(C_{\text{max}} - C_{\text{min}})) \\
      & \qquad C_{\text{max}} = s \\
      & \text{else} \\
      & \qquad C_{\text{mid}} = C_{\text{max}} = 0.0 \\
      & C_{\text{min}} = 0.0 \\
      & \text{return} \space C  
    \end{align}$
           
    <table id="table137" markdown="span">
        <caption>**Table 137 – Standard nonseparable blend modes**</caption>
        <thead>
            <tr>
                <th>**Name**</th>
                <th>**Result**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>**Hue**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(\text{SetSat}(C_s, \text{Sat}(C_b)), \text{Lum}(C_b))$<br/><br/>
                    NOTE 1&emsp; Creates a colour with the hue of the source colour and the saturation and luminosity of the backdrop colour.
                </td>
            </tr>
            <tr>
                <td>**Saturation**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(\text{SetSat}(C_b, \text{Sat}(C_s)), \text{Lum}(C_b))$<br/><br/>
                    NOTE 2&emsp; Creates a colour with the saturation of the source colour and the hue and luminosity of the backdrop colour. Painting with this mode in an area of the backdrop that is a pure gray (no saturation) produces no change.
                </td>
            </tr>
            <tr>
                <td>**Color**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(C_s, \text{Lum}(C_b))$<br/><br/>
                    NOTE 3&emsp; Creates a colour with the hue and saturation of the source colour and the luminosity of the backdrop colour. This preserves the gray levels of the backdrop and is useful for colouring monochrome images or tinting colour images.
                </td>
            </tr>
            <tr>
                <td>**Luminosity**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(C_b, \text{Lum}(C_s))$<br/><br/>
                    NOTE 4&emsp; Creates a colour with the luminosity of the source colour and the hue and saturation of the backdrop colour. This produces an inverse effect to that of the **Color** mode.
                </td>
            </tr>
        </tbody>
    </table>
    
    The formulas in this sub-clause apply to RGB spaces. Blending in *CMYK* spaces (including both **DeviceCMYK** and **ICCBased** calibrated *CMYK* spaces) shall be handled in the following way:
    
    - The *C*, *M*, and *Y* components shall be converted to their complementary *R*, *G*, and *B* components in the usual way. The preceding formulas shall be applied to the RGB colour values. The results shall be converted back to *C*, *M*, and *Y*.
    - For the *K* component, the result shall be the *K* component of $C_b$ for the **Hue**, **Saturation**, and **Color** blend modes; it shall be the *K* component of $C_s$ for the **Luminosity** blend mode.

=== "英文"

    In principle, any function of the backdrop and source colours that yields another colour, $C_r$, for the result may be used as a blend function $B(C_b , C_s)$, in the compositing formula to customize the blending operation. PDF defines a standard set of named blend functions, or *blend modes*, listed in Tables 136 and 137. Figures L.18 and L.19 in [Annex L] illustrate the resulting visual effects for *RGB* and *CMYK* colours, respectively.
    
    A blend mode is termed *separable* if each component of the result colour is completely determined by the corresponding components of the constituent backdrop and source colours—that is, if the blend mode function B is applied separately to each set of corresponding components:
    
    $c_r = B(c_b, c_s)$
    
    where the lowercase variables $c_r$, $c_b$ , and $c_s$ denote corresponding components of the colours $C_r$ , $C_b$ , and $C_s$ , expressed in additive form. A separable blend mode may be used with any colour space, since it applies independently to any number of components. Only separable blend modes shall be used for blending spot colours.
    
    !!! note "NOTE 1"
    
        Theoretically, a blend mode could have a different function for each colour component and still be separable; however, none of the standard PDF blend modes have this property.
    
    Table 136 lists the standard separable blend modes available in PDF and the algorithms/formulas that shall be used in the calculation of blended colours.
                        
    <table id="table136" markdown="span">
        <caption>**Table 136 – Standard separable blend modes**</caption>
        <thead>
            <tr>
                <th>**Name**</th>
                <th>**Result**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>**Normal**</td>
                <td>$B ( c_b , c_s ) = c_s$<br/><br/>
                    NOTE &emsp; Selects the source colour, ignoring the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Compatible**</td>
                <td>Same as Normal. This mode exists only for compatibility and should not be used.
                </td>
            </tr>
            <tr>
                <td>**Multiply**</td>
                <td>$B ( c_b , c_s ) = c_b \times c_s$<br/><br/>
                    NOTE 1 &emsp; Multiplies the backdrop and source colour values.<br/>
                    NOTE 2 &emsp; The result colour is always at least as dark as either of the two constituent colours. Multiplying any colour with black produces black; multiplying with white leaves the original colour unchanged. Painting successive overlapping objects with a colour other than black or white produces progressively darker colours.
                </td>
            </tr>
            <tr>
                <td>**Screen**</td>
                <td>$\begin{align} B(c_b,c_s) &= 1-[(1-c_b)\times (1-c_s)]\\   &= c_b + c_s -(c_b \times c_s) \end{align}$<br/><br/>
                    NOTE 3 &emsp; Multiplies the complements of the backdrop and source colour values, then complements the result.<br/>
                    NOTE 4 &emsp; The result colour is always at least as light as either of the two constituent colours. Screening any colour with white produces white; screening with black leaves the original colour unchanged. The effect is similar to projecting multiple photographic slides simultaneously onto a single screen.
                </td>
            </tr>
            <tr>
                <td>**Overlay**</td>
                <td>$B(c_b, c_s) = \text{HardLight}(c_s, c_b)$<br/><br/>
                    NOTE 5 &emsp; Multiplies or screens the colours, depending on the backdrop colour value. Source colours overlay the backdrop while preserving its highlights and shadows. The backdrop colour is not replaced but is mixed with the source colour to reflect the lightness or darkness of the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Darken**</td>
                <td>$B ( c_b , c_s ) = \text{min}(c_b, c_s)$<br/><br/>
                    NOTE 6 &emsp; Selects the darker of the backdrop and source colours. <br/>
                    NOTE 7 &emsp; The backdrop is replaced with the source where the source is darker; otherwise, it is left unchanged. 
                </td>
            </tr>
            <tr>
                <td>**Lighten**</td>
                <td>$B ( c_b , c_s ) = \text{max}(c_b, c_s)$<br/><br/>
                    NOTE 8 &emsp; Selects the lighter of the backdrop and source colours.<br/>
                    NOTE 9 &emsp; The backdrop is replaced with the source where the source is lighter; otherwise, it is left unchanged.<br/>
                </td>
            </tr>
            <tr>
                <td>**ColorDodge**</td>
                <td>$B(c_b, c_s) = \begin{cases}  \text{min}(1, c_b/(1-c_s))  & \text{if} \space c_s \lt 1 \\  1 & \text{if}  \space c_s = \end{cases}$<br/><br/>
                    NOTE 10 &emsp; Brightens the backdrop colour to reflect the source colour. Painting with black produces no changes.
                </td>
            </tr>
            <tr>
                <td>**ColorBurn**</td>
                <td>$B(c_b, c_s) = \begin{cases}  1 - \text{min}(1, (1-c_b)/c_s)  & \text{if} \space c_s \gt 0 \\  0 & \text{if}  \space c_s = \end{cases}$<br/><br/>
                    NOTE 11 &emsp; Darkens the backdrop colour to reflect the source colour. Painting with white produces no change.
                </td>
            </tr>
            <tr>
                <td>**HardLight**</td>
                <td>$B(c_b, c_s) = \begin{cases}  \text{Multiply}(c_b, 2 \times c_s) & \text{if} \space c_s \le 0.5 \\  \text{Screen}(c_b, 2\times c_s - 1) & \text{if}  \space c_s \gt 0.5 \end{cases}$<br/><br/>
                    NOTE 12 &emsp; Multiplies or screens the colours, depending on the source colour value. The effect is similar to shining a harsh spotlight on the backdrop.
                </td>
            </tr>
            <tr>
                <td>**SoftLight**</td>
                <td>$B(c_b, c_s) = \begin{cases}  c_b - (1-2\times c_s) \times c_b \times (1-c_b)  & \text{if} \space c_s \le 0.5 \\  c_b + (2 \times c_s - 1) \times (D(c_b) - c_b) & \text{if}  \space c_s \gt 0.5 \end{cases}$<br/>
                    **where**<br/>
                    $D(x) = \begin{cases}  ((16 \times x - 12) \times x + 4) \times x  & \text{if} \space x \le 0.25 \\  \sqrt{x}  & \text{if}  \space x \gt 0.25 \end{cases}$<br/><br/>
                    NOTE 13&emsp; Darkens or lightens the colours, depending on the source colour value. The effect is similar to shining a diffused spotlight on the backdrop.
                </td>
            </tr>
            <tr>
                <td>**Difference**</td>
                <td>$B(c_b,c_s) = |c_b - c_s|$<br/><br/>
                    NOTE 14 &emsp; Subtracts the darker of the two constituent colours from the lighter colour: <br/>
                    NOTE 15 &emsp; Painting with white inverts the backdrop colour; painting with black produces no change.
                </td>
            </tr>
            <tr>
                <td>**Exclusion**</td>
                <td>$B ( c_b , c_s ) = c_b + c_s - 2 \times c_b \times c_s$<br/><br/>
                    NOTE 16 &emsp; Produces an effect similar to that of the **Difference** mode but lower in contrast. Painting with white inverts the backdrop colour; painting with black produces no change.
                </td>
            </tr>
        </tbody>
    </table>
    
    Table 137 lists the standard nonseparable blend modes. Since the nonseparable blend modes consider all colour components in combination, their computation depends on the blending colour space in which the components are interpreted. They may be applied to all multiple-component colour spaces that are allowed as blending colour spaces (see [“Blending Colour Space](../c11/s3.md#1134-混合色彩空间)”).
    
    !!! note "NOTE 2"
        
        All of these blend modes conceptually entail the following steps:
        
        a) Convert the backdrop and source colours from the blending colour space to an intermediate HSL (hue-saturation-luminosity) representation.
        
        b) Create a new colour from some combination of hue, saturation, and luminosity components selected from the backdrop and source colours.
        
        c) Convert the result back to the original (blending) colour space.
        
        However, the following formulas given do not actually perform these conversions. Instead, they start with whichever colour (backdrop or source) is providing the hue for the result; then they adjust this colour to have the proper saturation and luminosity.
    
    The nonseparable blend mode formulas make use of several auxiliary functions. These functions operate on colours that are assumed to have red, green, and blue components. Blending of *CMYK* colour spaces requires special treatment, as described in this sub-clause.
    
    These functions shall have the following definitions:
    
    $\text{Lum}(C) = 0.3 \times C_{red} + 0.59 \times C_{green} + 0.11 \times C_{blue}$
    
    $\begin{align} 
      \text{SetLum}&(C, 1) \\
      & \text{let} \space d = 1 - \text{Lum}(C) \\
      & C_{\text{red} } = C_{\text{red} } + d \\
      & C_{\text{green} } = C_{\text{green} } + d \\
      & C_{\text{blue} } = C_{\text{blue} } + d \\
      & \text{returnClipColor}(C)  
    \end{align}$
    
    $\begin{align} 
      \text{ClipColor}&(C) \\
      & \text{let} \space l = \text{Lum}(C) \\
      & \text{let} \space n = \text{min}(C_{\text{red} }, C_{\text{green} }, C_{\text{blue} }) \\
      & \text{let} \space x = \text{max}(C_{\text{red} }, C_{\text{green} }, C_{\text{blue} }) \\
      & if \space n \lt 0.0 \\
      & \qquad C_{\text{red} } = l + (((C_{\text{red} } -l) \times l)/(l-n))\\
      & \qquad C_{\text{green} } = l + (((C_{\text{green} } -l) \times l)/(l-n))\\
      & \qquad C_{\text{blue} } = l + (((C_{\text{blue} } -l) \times l)/(l-n))\\
      & if \space n \gt 1.0 \\
      & \qquad C_{\text{red} } = l + (((C_{\text{red} } -l) \times (1 – l))/(x – l))\\
      & \qquad C_{\text{green} } = l + (((C_{\text{green} } -l) \times (1 – l))/(x – l))\\
      & \qquad C_{\text{blue} } = l + (((C_{\text{blue} } -l) \times (1 – l))/(x – l))\\
      & \text{return} \space C
    \end{align}$
    
    $\text{Sat}(C) = \text{max}(C_{\text{red}}, C_{\text{green}}, C_{\text{blue}}) - \text{min}(C_{\text{red}}, C_{\text{green}}, C_{\text{blue}})$
    
    The subscripts *min*, *mid*, and *max* (in the next function) refer to the colour components having the minimum, middle, and maximum values upon entry to the function.
    
    $\begin{align} 
      \text{SetSat}&(C, s) \\
      & \text{if} \space C_{\text{max}} \gt C_{\text{min}} \\
      & \qquad C_{\text{min}} = (((C_{\text{mid}} - C_{\text{min}}) \times s)/(C_{\text{max}} - C_{\text{min}})) \\
      & \qquad C_{\text{max}} = s \\
      & \text{else} \\
      & \qquad C_{\text{mid}} = C_{\text{max}} = 0.0 \\
      & C_{\text{min}} = 0.0 \\
      & \text{return} \space C  
    \end{align}$
           
    <table id="table137" markdown="span">
        <caption>**Table 137 – Standard nonseparable blend modes**</caption>
        <thead>
            <tr>
                <th>**Name**</th>
                <th>**Result**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>**Hue**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(\text{SetSat}(C_s, \text{Sat}(C_b)), \text{Lum}(C_b))$<br/><br/>
                    NOTE 1&emsp; Creates a colour with the hue of the source colour and the saturation and luminosity of the backdrop colour.
                </td>
            </tr>
            <tr>
                <td>**Saturation**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(\text{SetSat}(C_b, \text{Sat}(C_s)), \text{Lum}(C_b))$<br/><br/>
                    NOTE 2&emsp; Creates a colour with the saturation of the source colour and the hue and luminosity of the backdrop colour. Painting with this mode in an area of the backdrop that is a pure gray (no saturation) produces no change.
                </td>
            </tr>
            <tr>
                <td>**Color**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(C_s, \text{Lum}(C_b))$<br/><br/>
                    NOTE 3&emsp; Creates a colour with the hue and saturation of the source colour and the luminosity of the backdrop colour. This preserves the gray levels of the backdrop and is useful for colouring monochrome images or tinting colour images.
                </td>
            </tr>
            <tr>
                <td>**Luminosity**</td>
                <td>$B( C_b , C_s ) = \text{SetLum}(C_b, \text{Lum}(C_s))$<br/><br/>
                    NOTE 4&emsp; Creates a colour with the luminosity of the source colour and the hue and saturation of the backdrop colour. This produces an inverse effect to that of the **Color** mode.
                </td>
            </tr>
        </tbody>
    </table>
    
    The formulas in this sub-clause apply to RGB spaces. Blending in *CMYK* spaces (including both **DeviceCMYK** and **ICCBased** calibrated *CMYK* spaces) shall be handled in the following way:
    
    - The *C*, *M*, and *Y* components shall be converted to their complementary *R*, *G*, and *B* components in the usual way. The preceding formulas shall be applied to the RGB colour values. The results shall be converted back to *C*, *M*, and *Y*.
    - For the *K* component, the result shall be the *K* component of $C_b$ for the **Hue**, **Saturation**, and **Color** blend modes; it shall be the *K* component of $C_s$ for the **Luminosity** blend mode.

## 11.3.6 Alpha 的解释

**Interpretation of Alpha**

=== "中文"

    The colour compositing formula
    
    $C_r = \left ( 1- \frac{\alpha _s}{\alpha _r}  \right ) \times C_b + \frac{\alpha _s}{\alpha _r} \times [(1 - \alpha _b) \times C_s + \alpha_b \times B(C_b, C_s)]$
    
    produces a result colour that is a weighted average of the backdrop colour, the source colour, and the blended $B (C_b , C_s )$ term, with the weighting determined by the backdrop and source alphas $α_β$ and $α_s$ . For the simplest blend mode, **Normal**, defined by
    
    $B(c_b, c_s) = c_s$
    
    the compositing formula collapses to a simple weighted average of the backdrop and source colours, controlled by the backdrop and source alpha values. For more interesting blend functions, the backdrop and source alphas control whether the effect of the blend mode is fully realized or is toned down by mixing the result with the backdrop and source colours.
    
    The result alpha, $α_ρ$ , actually represents a computed result, described in [11.3.7], "Shape and Opacity Computations." The result colour shall be normalized by the result alpha, ensuring that when this colour and alpha are subsequently used together in another compositing operation, the colour’s contribution is correctly represented.
    
    !!! note "NOTE 1"
    
        If $α_ρ$ is zero, the result colour is undefined.
    
    !!! note "NOTE 2"
    
        The preceding formula represents a simplification of the following formula, which presents the relative contributions of backdrop, source, and blended colours in a more straightforward way:
    
        $\alpha_r \times C_r = [(1 - \alpha _s) \times \alpha _b \times C_b] + [(1 - \alpha _b) \times \alpha _s \times C_s] + [\alpha _b \times \alpha _s \times B(C_b, C_s)]$
    
        (The simplification requires a substitution based on the alpha compositing formula, which is presented in the next sub-clause.) Thus, mathematically, the backdrop and source alphas control the influence of the backdrop and source colours, respectively, while their product controls the influence of the blend function. An alpha value of $α_s = 0.0$ or $α_β = 0.0$ results in no blend mode effect; setting $α_s = 1.0$ and $α_β = 1.0$ results in maximum blend mode effect.

=== "英文"

    The colour compositing formula
    
    $C_r = \left ( 1- \frac{\alpha _s}{\alpha _r}  \right ) \times C_b + \frac{\alpha _s}{\alpha _r} \times [(1 - \alpha _b) \times C_s + \alpha_b \times B(C_b, C_s)]$
    
    produces a result colour that is a weighted average of the backdrop colour, the source colour, and the blended $B (C_b , C_s )$ term, with the weighting determined by the backdrop and source alphas $α_β$ and $α_s$ . For the simplest blend mode, **Normal**, defined by
    
    $B(c_b, c_s) = c_s$
    
    the compositing formula collapses to a simple weighted average of the backdrop and source colours, controlled by the backdrop and source alpha values. For more interesting blend functions, the backdrop and source alphas control whether the effect of the blend mode is fully realized or is toned down by mixing the result with the backdrop and source colours.
    
    The result alpha, $α_ρ$ , actually represents a computed result, described in [11.3.7], "Shape and Opacity Computations." The result colour shall be normalized by the result alpha, ensuring that when this colour and alpha are subsequently used together in another compositing operation, the colour’s contribution is correctly represented.
    
    !!! note "NOTE 1"
    
        If $α_ρ$ is zero, the result colour is undefined.
    
    !!! note "NOTE 2"
    
        The preceding formula represents a simplification of the following formula, which presents the relative contributions of backdrop, source, and blended colours in a more straightforward way:
    
        $\alpha_r \times C_r = [(1 - \alpha _s) \times \alpha _b \times C_b] + [(1 - \alpha _b) \times \alpha _s \times C_s] + [\alpha _b \times \alpha _s \times B(C_b, C_s)]$
    
        (The simplification requires a substitution based on the alpha compositing formula, which is presented in the next sub-clause.) Thus, mathematically, the backdrop and source alphas control the influence of the backdrop and source colours, respectively, while their product controls the influence of the blend function. An alpha value of $α_s = 0.0$ or $α_β = 0.0$ results in no blend mode effect; setting $α_s = 1.0$ and $α_β = 1.0$ results in maximum blend mode effect.

## 11.3.7 形状和不透明度计算

**Shape and Opacity Computations**

### 11.3.7.1 概述

**General**

=== "中文"

    As stated earlier, the alpha values that control the compositing process shall be defined as the product of shape and opacity:
    
    $\begin{align} 
      &\alpha _{_b} = f_{_b} \times q_{_b} \\
      &\alpha _{_r} = f_{_r} \times q_{_r} \\
      &\alpha _{_s} = f_{_s} \times q_{_s}
    \end{align}$
    
    This sub-clause examines the various shape and opacity values individually. Once again, keep in mind that conceptually these values are computed for every point on the page.

=== "英文"

    As stated earlier, the alpha values that control the compositing process shall be defined as the product of shape and opacity:
    
    $\begin{align} 
      &\alpha _{_b} = f_{_b} \times q_{_b} \\
      &\alpha _{_r} = f_{_r} \times q_{_r} \\
      &\alpha _{_s} = f_{_s} \times q_{_s}
    \end{align}$
    
    This sub-clause examines the various shape and opacity values individually. Once again, keep in mind that conceptually these values are computed for every point on the page.

### 11.3.7.2 源形状和不透明度

**Source Shape and Opacity**

=== "中文"

    Shape and opacity values may come from several sources. The transparency model provides for three independent sources for each. However, the PDF representation imposes some limitations on the ability to specify all of these sources independently (see “[Specifying Shape and Opacity](./s6.md#1164-指定形状和不透明度)”).
    
    - *Object shape*. Elementary objects such as strokes, fills, and text have an intrinsic shape, whose value shall be 1.0 for points inside the object and 0.0 outside. Similarly, an image with an explicit mask (see “[Explicit Masking](../c8/s9.md#8963-显式掩蔽)”) has a shape that shall be 1.0 in the unmasked portions and 0.0 in the masked portions. The shape of a group object shall be the union of the shapes of the objects it contains.
    
    !!! note "NOTE 1"
    
        Mathematically, elementary objects have “hard” edges, with a shape value of either 0.0 or 1.0 at every point. However, when such objects are rasterized to device pixels, the shape values along the boundaries may be anti-aliased, taking on fractional values representing fractional coverage of those pixels. When such anti- aliasing is performed, it is important to treat the fractional coverage as shape rather than opacity.
    
    - Mask shape. Shape values for compositing an object may be taken from an additional source, or soft mask, independent of the object itself, as described in [11.5], "Soft Masks."
    
    !!! note "NOTE 2"
    
        The use of a soft mask to modify the shape of an object or group, called soft clipping, can produce effects such as a gradual transition between an object and its backdrop, as in a vignette.
    
    - Constant shape. The source shape may be modified at every point by a scalar shape constant.
    
    !!! note "NOTE 3"
    
        This is merely a convenience, since the same effect could be achieved with a shape mask whose value is the same everywhere.
    
    - *Object opacity*. Elementary objects have an opacity of 1.0 everywhere. The opacity of a group object shall be the result of the opacity computations for all of the objects it contains.
    - *Mask opacity*. Opacity values, like shape values, may be provided by a soft mask independent of the object being composited.
    - *Constant opacity*. The source opacity may be modified at every point by a scalar *opacity constant*.
    
    !!! note "NOTE 4"
    
        It is useful to think of this value as the “current opacity,” analogous to the current colour used when painting elementary objects.
    
    All of the shape and opacity inputs shall have values in the range 0.0 to 1.0 (inclusive), with a default value of 1.0.
    
    The three shape inputs shall be multiplied together, producing an intermediate value called the source shape.
    
    $f_{_s} = f_{_j} \times f_{_m} \times f_{_k}$
    
    The three opacity inputs shall be multiplied together, producing an intermediate value called the source opacity.
    
    $q_{_s} = q_{_j} \times q_{_m} \times q_{_k}$
    
    Where the variables have the meanings shown in Table 138.
               
    <table id="table138" markdown="span">
        <caption>**Table 138 – Variables used in the source shape and opacity formulas**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$f_{_s}$</td>
                <td>Source shape</td>
            </tr>
            <tr>
                <td>$f_{_j}$</td>
                <td>Object shape</td>
            </tr>
            <tr>
                <td>$f_{_m}$</td>
                <td>Mask shape</td>
            </tr>
            <tr>
                <td>$f_{_k}$</td>
                <td>Constant shape</td>
            </tr>
            <tr>
                <td>$q_{_s}$</td>
                <td>Source opacity</td>
            </tr>
            <tr>
                <td>$q_{_j}$</td>
                <td>Object opacity</td>
            </tr>
            <tr>
                <td>$q_{_m}$</td>
                <td>Mask opacity</td>
            </tr>
            <tr>
                <td>$q_{_k}$</td>
                <td>Constant opacity</td>
            </tr>
        </tbody>
    </table>
    
    !!! note "NOTE 5"
    
        The effect of each of these inputs is that the painting operation becomes more transparent as the input values decreases.
    
    When an object is painted with a tiling pattern, the object shape and object opacity for points in the object’s interior are determined by those of corresponding points in the pattern, rather than being 1.0 everywhere (see [“Patterns and Transparency](./s6.md#1167-图案和透明度)”).

=== "英文"

    Shape and opacity values may come from several sources. The transparency model provides for three independent sources for each. However, the PDF representation imposes some limitations on the ability to specify all of these sources independently (see “[Specifying Shape and Opacity](./s6.md#1164-指定形状和不透明度)”).
    
    - *Object shape*. Elementary objects such as strokes, fills, and text have an intrinsic shape, whose value shall be 1.0 for points inside the object and 0.0 outside. Similarly, an image with an explicit mask (see “[Explicit Masking](../c8/s9.md#8963-显式掩蔽)”) has a shape that shall be 1.0 in the unmasked portions and 0.0 in the masked portions. The shape of a group object shall be the union of the shapes of the objects it contains.
    
    !!! note "NOTE 1"
    
        Mathematically, elementary objects have “hard” edges, with a shape value of either 0.0 or 1.0 at every point. However, when such objects are rasterized to device pixels, the shape values along the boundaries may be anti-aliased, taking on fractional values representing fractional coverage of those pixels. When such anti- aliasing is performed, it is important to treat the fractional coverage as shape rather than opacity.
    
    - Mask shape. Shape values for compositing an object may be taken from an additional source, or soft mask, independent of the object itself, as described in [11.5], "Soft Masks."
    
    !!! note "NOTE 2"
    
        The use of a soft mask to modify the shape of an object or group, called soft clipping, can produce effects such as a gradual transition between an object and its backdrop, as in a vignette.
    
    - Constant shape. The source shape may be modified at every point by a scalar shape constant.
    
    !!! note "NOTE 3"
    
        This is merely a convenience, since the same effect could be achieved with a shape mask whose value is the same everywhere.
    
    - *Object opacity*. Elementary objects have an opacity of 1.0 everywhere. The opacity of a group object shall be the result of the opacity computations for all of the objects it contains.
    - *Mask opacity*. Opacity values, like shape values, may be provided by a soft mask independent of the object being composited.
    - *Constant opacity*. The source opacity may be modified at every point by a scalar *opacity constant*.
    
    !!! note "NOTE 4"
    
        It is useful to think of this value as the “current opacity,” analogous to the current colour used when painting elementary objects.
    
    All of the shape and opacity inputs shall have values in the range 0.0 to 1.0 (inclusive), with a default value of 1.0.
    
    The three shape inputs shall be multiplied together, producing an intermediate value called the source shape.
    
    $f_{_s} = f_{_j} \times f_{_m} \times f_{_k}$
    
    The three opacity inputs shall be multiplied together, producing an intermediate value called the source opacity.
    
    $q_{_s} = q_{_j} \times q_{_m} \times q_{_k}$
    
    Where the variables have the meanings shown in Table 138.
               
    <table id="table138" markdown="span">
        <caption>**Table 138 – Variables used in the source shape and opacity formulas**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$f_{_s}$</td>
                <td>Source shape</td>
            </tr>
            <tr>
                <td>$f_{_j}$</td>
                <td>Object shape</td>
            </tr>
            <tr>
                <td>$f_{_m}$</td>
                <td>Mask shape</td>
            </tr>
            <tr>
                <td>$f_{_k}$</td>
                <td>Constant shape</td>
            </tr>
            <tr>
                <td>$q_{_s}$</td>
                <td>Source opacity</td>
            </tr>
            <tr>
                <td>$q_{_j}$</td>
                <td>Object opacity</td>
            </tr>
            <tr>
                <td>$q_{_m}$</td>
                <td>Mask opacity</td>
            </tr>
            <tr>
                <td>$q_{_k}$</td>
                <td>Constant opacity</td>
            </tr>
        </tbody>
    </table>
    
    !!! note "NOTE 5"
    
        The effect of each of these inputs is that the painting operation becomes more transparent as the input values decreases.
    
    When an object is painted with a tiling pattern, the object shape and object opacity for points in the object’s interior are determined by those of corresponding points in the pattern, rather than being 1.0 everywhere (see [“Patterns and Transparency](./s6.md#1167-图案和透明度)”).

### 11.3.7.3 结果形状和不透明度

**Result Shape and Opacity**

=== "中文"

    In addition to a result colour, the painting operation also shall compute an associated result shape and *result opacity*. These computations shall be based on the *union function*
    
    $\begin{align} 
      \text{Union}(b, s) &= 1 - [(1-b) \times (1-s)] \\
      &=b + s - (b \times s)
    \end{align}$
    
    where *b* and *s* shall be the backdrop and source values to be composited.
    
    !!! note "NOTE 1"
    
        This is a generalization of the conventional concept of union for opaque shapes, and it can be thought of as an “inverted multiplication”—a multiplication with the inputs and outputs complemented. The result tends toward 1.0: if either input is 1.0, the result is 1.0.
    
    The result shape and opacity shall be given by
    
    $\begin{align} 
      & f_r = \text{Union}(f_b, f_s) \\ \\
      & q_r = \frac{\text{Union}(f_b \times q_b, f_s \times q_s) }{f_r} 
    \end{align}$
    
    where the variables have the meanings shown in Table 139.
               
    <table id="table139" markdown="span">
        <caption>**Table 139 – Variables used in the result shape and opacity formulas**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$f_r$</td>
                <td>Result shape</td>
            </tr>
            <tr>
                <td>$f_b$</td>
                <td>Backdrop shape</td>
            </tr>
            <tr>
                <td>$f_s$</td>
                <td>Source shape</td>
            </tr>
            <tr>
                <td>$q_r$</td>
                <td>Result opacity</td>
            </tr>
            <tr>
                <td>$q_b$</td>
                <td>Backdrop opacity</td>
            </tr>
            <tr>
                <td>$q_s$</td>
                <td>Source opacity</td>
            </tr>
        </tbody>
    </table>
    
    These formulas shall be interpreted as follows:
    
    - The result shape shall be the union of the backdrop and source shapes.
    - The result opacity shall be the union of the backdrop and source opacities, weighted by their respective shapes. The result shall then be divided by (normalized by) the result shape.
    
    !!! note "NOTE 2"
    
        Since alpha is just the product of shape and opacity, it can easily be shown that
    
        $\alpha _r = \text{Union}(\alpha _b, \alpha _s)$
        
        This formula can be used whenever the independent shape and opacity are not needed.

=== "英文"

    In addition to a result colour, the painting operation also shall compute an associated result shape and *result opacity*. These computations shall be based on the *union function*
    
    $\begin{align} 
      \text{Union}(b, s) &= 1 - [(1-b) \times (1-s)] \\
      &=b + s - (b \times s)
    \end{align}$
    
    where *b* and *s* shall be the backdrop and source values to be composited.
    
    !!! note "NOTE 1"
    
        This is a generalization of the conventional concept of union for opaque shapes, and it can be thought of as an “inverted multiplication”—a multiplication with the inputs and outputs complemented. The result tends toward 1.0: if either input is 1.0, the result is 1.0.
    
    The result shape and opacity shall be given by
    
    $\begin{align} 
      & f_r = \text{Union}(f_b, f_s) \\ \\
      & q_r = \frac{\text{Union}(f_b \times q_b, f_s \times q_s) }{f_r} 
    \end{align}$
    
    where the variables have the meanings shown in Table 139.
               
    <table id="table139" markdown="span">
        <caption>**Table 139 – Variables used in the result shape and opacity formulas**</caption>
        <thead>
            <tr>
                <th>**Variable**</th>
                <th>**Meaning**</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td>$f_r$</td>
                <td>Result shape</td>
            </tr>
            <tr>
                <td>$f_b$</td>
                <td>Backdrop shape</td>
            </tr>
            <tr>
                <td>$f_s$</td>
                <td>Source shape</td>
            </tr>
            <tr>
                <td>$q_r$</td>
                <td>Result opacity</td>
            </tr>
            <tr>
                <td>$q_b$</td>
                <td>Backdrop opacity</td>
            </tr>
            <tr>
                <td>$q_s$</td>
                <td>Source opacity</td>
            </tr>
        </tbody>
    </table>
    
    These formulas shall be interpreted as follows:
    
    - The result shape shall be the union of the backdrop and source shapes.
    - The result opacity shall be the union of the backdrop and source opacities, weighted by their respective shapes. The result shall then be divided by (normalized by) the result shape.
    
    !!! note "NOTE 2"
    
        Since alpha is just the product of shape and opacity, it can easily be shown that
    
        $\alpha _r = \text{Union}(\alpha _b, \alpha _s)$
        
        This formula can be used whenever the independent shape and opacity are not needed.

## 11.3.8 基本合成计算总结

**Summary of Basic Compositing Computations**

=== "中文"

    This sub-clause is a summary of all the computations presented in this sub-clause. They are given in an order such that no variable is used before it is computed; also, some of the formulas have been rearranged to simplify them. See Tables [135](#table135), [138](#table138), and [139](#table139) for the meanings of the variables used in these formulas.
    
    $\begin{align} 
      \text{Union}(b,s) &= 1 - [(1 - b) \times (1 - s)] \\ 
      & = b + s - (b \times s)
    \end{align}$
    
    $\begin{align} 
      &f_s = f_j \times f_m \times f_k \\
      &q_s = q_j \times q_m \times q_k \\
      &f_r = \text{Union}(f_b, f_s) \\\\
      &\alpha_b = f_b \times q_b \\
      &\alpha_s = f_s \times q_s \\
      &\alpha_r = \text{Union}(\alpha_b, \alpha_s)\\\\
      &q_r = \frac{\alpha _r}{f_r} \\\\
      &C_r = \left ( 1 - \frac{\alpha _s}{\alpha _r} \right )  \times C_b + \frac{\alpha _s}{\alpha _r} \times [(1 - \alpha _b) \times C_s + \alpha _b \times B(C_b, C_s)]
    \end{align}$

=== "英文"

    This sub-clause is a summary of all the computations presented in this sub-clause. They are given in an order such that no variable is used before it is computed; also, some of the formulas have been rearranged to simplify them. See Tables [135](#table135), [138](#table138), and [139](#table139) for the meanings of the variables used in these formulas.
    
    $\begin{align} 
      \text{Union}(b,s) &= 1 - [(1 - b) \times (1 - s)] \\ 
      & = b + s - (b \times s)
    \end{align}$
    
    $\begin{align} 
      &f_s = f_j \times f_m \times f_k \\
      &q_s = q_j \times q_m \times q_k \\
      &f_r = \text{Union}(f_b, f_s) \\\\
      &\alpha_b = f_b \times q_b \\
      &\alpha_s = f_s \times q_s \\
      &\alpha_r = \text{Union}(\alpha_b, \alpha_s)\\\\
      &q_r = \frac{\alpha _r}{f_r} \\\\
      &C_r = \left ( 1 - \frac{\alpha _s}{\alpha _r} \right )  \times C_b + \frac{\alpha _s}{\alpha _r} \times [(1 - \alpha _b) \times C_s + \alpha _b \times B(C_b, C_s)]
    \end{align}$

[11.5]: ./s5.md
[11.7]: ./s7.md
[11.4]: ./s4.md

[11.3.3]: #1133-基本合成公式
[11.3.7]: #1137-形状和不透明度计算

[8.6.6.4]: ../c8/s6.md#8664-分离色彩空间

[Annex L]: ../a12.md